---
layout: post
title: "红外寻迹避障电路设计"
author: unKnown
layout: post
description: "设计一种反射式光电传感器"
category: 技术分享
tags: 
  - 传感器
  - 电路
---

　　反射式光电传感器在机器人中有着广泛的应用。可以用来检测地面明暗和颜色的变化，也可以探测有无接近的物体。这种光电传感器的基本原理是，自带一个光源和一个光接收装置，光源发出的光经过待测物体的反射被光敏元件接收，再经过相关电路的处理得到所需要的信息。相应的，光谱范围，灵敏度，抗干扰能力，输出特性等都是反射式光电传感器的重要参数。

<!--more-->

##简单比较型光电传感器

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 PhotoelectricSensor.png" style="width:451px" alt="比较型光电传感器">
</div>

　　在上左图中，JP1是光电管，接收光强在上面转换成电流，在R上成为电压信号，与RA1的标准值进行比较，从LM339输出逻辑电平给单片机。

　　R越大，光电流产生的电压变化越大，传感器也就越灵敏。但是若R过大，当光比较强的时候，R上的电压会达到VCC而不再变化，这就是所谓的饱和。在这种比较型的传感器电路中，饱和只会使强光与强光难以分辨，但仍可以区分强光和弱光，它并不是影响比较结果的重要因素。但在后面介绍的几种调制型传感器中，饱和是必须避免的，因为它会掩盖交流分量。高灵敏度和饱和是一对矛盾，在后面提到了一些相关的解决方案。

　　LM339是开路输出的，10K的电阻是为了使输出电压正确。如果后面是51之类开路输入的单片机，这个电阻可以省略。

　　假如把光敏管放在下边,电阻放在上边。这样当光线较暗时比较器输入电压接近VCC，超过比较器LM339能够正常工作的最高输入电压Vm,比较器不能正常工作（LM339的共模输入电压最低能低到0，但是最高达不到VCC），因此灵敏度做不高。为了使比较器正常工作，电阻值应使得光照时比较器输入电压Vi大幅下降，满足VCC-I*R<Vm（I是光电流），就是I*R>VCC-Vm。这样，光再强一点，I*R接近VCC,Vi就会降到0附近，光敏管就会饱和，降低了区分颜色的可靠性。

　　而现在把光敏管放在上边,电阻放在下边，就可以解决这个问题：这时Vi=I*R,使用较小的R可以保证Vi<Vm<VCC,不会发生电压范围溢出或者光敏管饱和。这时为了保证光照与输出有相同的逻辑关系（光照时输出低电平，指示灯亮），比较器的同相和反相输入端要互换。

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 Constant_current.png" style="width:451px" alt="恒流电路">
</div>

　　上图为给发光管供电的恒流电路(I=0.9V/R1)，恒流的工作过程是：D11起稳压作用，如果电流偏大，R1分压变大，T1的VBE降低，使电流减小；反之亦然。这个负反馈过程使电流恒定，R1上的电压恒定在D11压降和VBE之差，约0.9V。改变R20对地的通断也可以控制发光管的亮灭。这样可以使用很小的R或设置比较高的基准电压，只有很强的光输入才能触发电路。这时在恒流源中三极管的发射极电阻上并联一个电容后，就可以用单片机控制探头照明的LED发出短而强的光脉冲并进行随机调制和解调，提高抗干扰能力，成为调制型传感器电路的一种。

##高通滤波型光电传感器

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 High_pass.png" style="width:800px" alt="高通滤波">
</div>

　　光源是用一个脉冲振荡电流去点亮发光二极管，电路图没有画出，可以使用任何一种振荡电路，平均电流根据发光二极管的参数可以取到20mA左右。

　　接收部分是这样工作的:传感器信号先经过CR高通网络去掉直流和低频成分,并加入一个直流offset,也就是一个稳定的直流分量叠加一个交流分量,再与一个设定的直流分量进行比较,如果交流分量的峰值超过offset与设定值之差,比较器就会输出一个方波脉冲,否则输出0;然后通过RC低通网络,使方波脉冲的交流分量尽可能的减小,变成某个直流电压V(>0),再与另一个设定值(<V)比较,输出低电平.如果没有交流输入,第一级比较器输出0,第二级比较器输出高电平,如下表所示:（仿真结果）

<img src="{{ site.img_path }}/2013-12-29 simulation1.png" width="300" height="250" alt="仿真结果1" /> <img src="{{ site.img_path }}/2013-12-29 simulation2.png" width="300" height="250" alt="仿真结果2" />

<img src="{{ site.img_path }}/2013-12-29 simulation3.png" width="300" height="250" alt="仿真结果3" /> <img src="{{ site.img_path }}/2013-12-29 simulation4.png" width="300" height="250" alt="仿真结果4" />

　　这种电路可以在未饱和的情况下抵御外界非交流光以及瞬间光（如闪光灯）的干扰，但收到高频光的干扰时会产生误动作。

##使用LM567的调制传感器

　　LM567是一种廉价的音频锁相环集成电路，利用它可以构造性能较好的反射式光电传感器。

　　如下图所示，由LM567的内部振荡器提供方波信号，点亮探头的LED，由探头的光敏管接收反射光。经三极管放大，转换成电压信号后送到LM567的内部鉴相器2（输出鉴相器）同步解调，然后由LM567内部的比较器转换为数字输出。

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 LM567_ex.png" style="width:800px" alt="LM567_ex">
</div>

　　并联负反馈放大电路有着稳定的增益和低的输入阻抗，能消除光敏管结电容的影响，获得良好的高频特性。
　　200K电位器（R6,200K adjustable） 用于调节放大器增益以调节灵敏度。

　　在outi和outo之间的510K电阻和1000p电容用于给比较器添加50mV的滞回，消除调制频率纹波造成的输出抖动。其中1000p电容的作用是补偿C1的影响，加快输出跳变。

　　这个电路的缺点是当多个探头同时使用时因为频率接近，一旦相邻单元的光斑出现部分重合就会有差拍干扰造成输出抖动。另外，567输出鉴相器的参考信号是从振荡电容端引出的，与发射和接收信号几乎是正交的，解调效率非常低，前级需要高倍放大。

	为了解决上述多个探头临近的问题，在使用多组传感器时，做了如下图的改动：

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 LM567.png" style="width:800px" alt="LM567">
</div>

　　单独用一个单元（图中右边的567）作振荡,给其余4个单元（图中只画了一个）提供同步的时钟信号，消除了差拍问题。而且时钟信号既接到振荡电容端又用来控制输出放大管点亮探头照明的LED，使得参考信号与发射和接收信号的相差非常小，解调效率大大提高，最大探测距离有所增加。

　　注意探头的连线要短，如果连线较长要分别屏蔽，最好把电路板跟探头做在一起。否则发射管连线上大幅度的脉冲信号会感应耦合到接收端，导致在没有接收光的情况下也误认为收到了光信号，这种同频干扰无法用电路板上的设计来消除。

##38k红外避障电路

　　采用左右两个红外传感器。红外传感器，是目前使用比较普遍的一种避障传感器，其处理电路如图4所示，通过调节R23、R24两个电位器，可调节两个红外传感器的检测距离为10—80cm，开关量输出（TTL电平），简单、可靠。我们采用这种电路，能可靠地检测左前方、右前方、前方的障碍情况，为成功避障提供了保证图中P1.1那儿应没有节点。

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 Infrared transmitter.png" style="width:800px" alt="红外发射及接收处理电路">
</div>

* 38K调制和发射电路。使用一个定时器的快速PWM模式产生38K调制信号，通过剩余的四个施密特触发器（有2个已经用在光电编码部分）缓冲，推动8050三极管和红外发光管来发射已经调制的红外线。其中2个1N4148接单片机IO脚，控制左右红外发光管轮流发射。后面串接的可见光LED是为了方便用户调试而设置的，让用户知道当前是否在发射红外线。通过调节PWM的占空比，调节红外发光管的亮度，从而实现调节感知障碍物距离的功能。

![发射电路]({{ site.img_path }}/2013-12-29 Transmitting circuit.png)

* 一体化接收部分。这部分很简单，平时接受头输出高电平，检测到反射回来的红外线后输出低电平。

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 Receiving part.png" style="width:300px" alt="Receiving part">
</div>

* 发现障碍物指示部分。通过单片机接受到一体化接受头的信号，判断障碍物在哪边，然后点亮2个LED，方便调试，这2个LED和发射部分的指示LED可以使用贴片LED做在主板上即可。

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 Instructions section.png" style="width:450px" alt="指示部分">
</div>

##伪随机编码的调制传感器(方案)

　　该方案的硬件比较简单，不加详述，总体结构如下：

　　发端: 2051=>驱动=>LED

　　收端: 光电管=>(放大)=>高通=>过门限检测=>2051

　　关键的问题是怎样判断是否有反射。比如向发光管发送一串8bit的随机数，从接收管读出，如果相符，说明有反射；如果无关（具体判断的算法有待设计）说明无反射；如果部分相关，则保持原状。具体算法的实现可能要设计一个较为简单快速的判断相关度的程序。

##使用ADC的传感器电路

　　这种方案就是让发光管亮灭交替,用ADC（模数转换器）分别检测亮暗时光电流的值,然后送到单片机进行相减，再根据某些标准进行判断。这样，就抵消了环境噪声，消除了干扰。光电管的饱和问题仍旧是这个电路的问题，并且，当干扰频率接近发光管调制频率时会产生差拍或出错。

　　下图是一个利用ADC做的RGB三分量颜色传感器电路：

![颜色传感器电路]({{ site.img_path }}/2013-12-29 Color sensor circuit.png)

　　89C2051作为主控，控制红绿蓝三个发光管依次点亮，一个周期分别是红，绿，蓝，全灭。在每次改变之前，对光电管进行ADC采样，读取相关颜色的分量，分别是红，绿，蓝，暗分量，然后用三原色分量分别减去暗分量，这样就消除了环境光的干扰。最后通过相应的算法，判断出反光物的颜色。

##模拟差动放大型传感器电路(方案)

![差动放大型传感器]({{ site.img_path }}/2013-12-29 Differential amplifier sensor.png)

　　类似于使用ADC的方案，该方案也是对亮暗分别采样。但不同的是，该方案采用了采样保持和模拟相减。运放作为差动放大，有良好的共模抑制，不会像ADC那样为减小饱和，照顾大的共模信号而扩大量程降低精度。因此该方案可以兼顾饱和现象和灵敏度，解决了这一矛盾。对于较快的采样，可以简单的使用高输入阻抗的运放本身加一个小电容进行保持。缺点是仍不能抑制高频干扰。

##使用D触发器进行边沿检测的传感器电路

　　也是让发光管亮暗交替,但亮的时间很短,电流很大,亮度很高,把接收端门限调的很高,然后用D触发器进行边沿检测。这样可以屏蔽外界一般强度光（可以是高频的）的干扰，而耗电不会增加。但如果使用简单的比较型电路，加大电流就会增大功耗，甚至烧毁发光管。

##下图是一个成品光电开关

　　就是光电管=>两级交流放大=>CD4013检测 这种方式的,CD4013的另一个单元D触发器作方波振荡源,通过驱动电路带动LED。可以看出，LED的限流电阻是20欧，短时间通过LED的电流很大。

![光电开关]({{ site.img_path }}/2013-12-29 Photoelectric switch.png)

##传感器的输出接口问题

　　TTL电压工作的推挽输出传感器接5V电源的单片机

　　TTL电压工作的传感器可以直接输出到单片机，但为了避免不慎从单片机该端口输出低电平，可以在传感器和单片机之间接一个1K左右的电阻。

　　开路输出的传感器接51单片机

　　如果完全开路输出，可以直接接到单片机上，如果使用P0口应该加上拉电阻；如果传感器内置上拉电阻而且高电平时高于5V，可以从单片机到传感器端口接一个肖特基二极管，防止高压灌入单片机。上面图中的成品传感器就是这种接口的。

　　非TTL电压推挽输出的传感器接51单片机

　　这种接口的基本做法就是串入电阻进行限流防止输出冲突；单片机端用稳压二极管进行限压防止输入过压。

　　这3种情况如下图所示：

<div style="text-align:center"><img src="{{site.img_path}}/2013-12-29 Case 3.png" style="width:450px" alt="3种情况">
</div>

##反射式光电传感器探头的制作

###发光二极管(LED)的介绍

　　传感器的LED要求亮度高，颜色合适，光斑形状合适。

　　为了防止LED损坏,应该注意:1.LED的伏安特性曲线很陡,测试和使用时一定要串联电阻限制电流. 2.氮化镓材料的高亮度LED容易被反向电压,静电或电源尖峰击穿损坏,电源电压较高时不可反接。

　　不同的管子允许的工作电流不同。红外的平均电流最大可以用到100毫安，用作调制时几十微秒的窄脉冲峰值甚至可以接近1安。3毫米的白色高亮度管子持续最大电流20毫安，一般低亮度的管子要小一些。工作电流的限制一是发热限制平均电流，二是高电流下亮度饱和限制峰值电流。有些管子电流大了之后还会变色。

　　常用的LED有红外，红，橙，黄，黄绿，纯绿，蓝，紫，紫外，白等颜色。作为成品销售的“变色LED”是在一个管壳（通常是乳白色的，用于使光线混合均匀）里封装了多个不同颜色的LED，红，绿，蓝三色的LED非常适合作颜色传感器的照明。**红外线LED配合红外接收管抗干扰能力强，但是不适合用于识别颜色，因为物体在可见光下的颜色不能很好的代表它对于红外线的反射率。**验钞用的管子发光含有紫色光和紫外线，点亮时不要正对着眼睛长时间观看。更适合做传感器。（颜色识别时，乳白色管壳比无色透明管壳还要好。）管壳有色的管子适合

　　管壳无色透明的管子透光性能好一些，散射小，做指示灯。直径5毫米的管子品种较多，亮度较高，发出的光束比直径3毫米的管子要集中（顶角小），照在物体上光斑小，更适合用来识别白线。LED的伏安特性曲线很陡,可以作稳压用,给电路提供基准电压.红色的大约1.8V,蓝色的可以超过3V。

####各种LED的材料，颜色与亮度：

　　LED发光的原理是半导体PN结中的电子与空穴复合时产生光子。不同的材料由于能带宽度不同,导致发光颜色和导通电压不同。另外,不同材料的发光效率（一般以量子效率衡量，量子效率=发射的光子数/流过的电子数）也有极大的差别。

<table class="table table-bordered table-striped table-condensed table-hover">
<tr>
    <th>材料</th>
    <th>发光颜色</th>
    <th>量子效率(与工艺有关,这里是典型值)</th>
</tr>
<tr>
    <th>砷化镓GaAs</th>
    <th>红外</th>
    <th>高,30%</th>
</tr>
<tr>
    <th>磷砷化镓GaAsP </th>
    <th>红</th>
    <th>中,10% (购买时称为普通)</th>
</tr>
<tr>
    <th>磷化镓掺杂氮GaP:N</th>
    <th>黄绿</th>
    <th>低,不到1% (购买时称为普通)</th>
</tr>
<tr>
    <th>磷化镓掺杂氧化锌GaP:ZnO</th>
    <th>红到黄</th>
    <th>中低 (购买时称为普通)</th>
</tr>
<tr>
    <th>铝砷化镓AlGaAs</th>
    <th>鲜红</th>
    <th>中高 (购买时称为高亮度)</th>
</tr>
<tr>
    <th>铝镓铟磷AlGaInP</th>
    <th>橙红</th>
    <th>高,30% (购买时称为超高亮度)</th>
</tr>
<tr>
    <th>氮化镓GaN (含In)</th>
    <th>从纯绿到紫外</th>
    <th>高,20% (购买时称为高或超高亮度)</th>
</tr>
<tr>
    <th>GaN,管芯外涂荧光粉</th>
    <th>紫+黄=白</th>
    <th>高 (购买时称为高或超高亮度)</th>
</tr>
</table>

###接收管的介绍

　　常用的接收管有硅光电二极管，硅光电三极管，光敏电阻三种。光电二极管产生的电流小（微安级），需要高倍放大，但是速度很高，可以高频调制。在遮光状态下的特性类似普通二极管。使用时加反向电压，输出与光照强度近似成正比的光电流。光电三极管一般基极不引出，只有两根管脚，购买的时候叫做光敏管。光电三极管产生的电流较大（几百微安以上），无需前置高倍放大，但是速度较低，调制频率低于100KHz。遮光状态下正反向电阻都很大，用强光（比如台灯）照射，可以测出一个方向的电阻明显变小，这个方向是正向。使用时加正向电压>1V，输出与光照强度近似成正比的光电流。

　　这些光电接收管的外壳有无色透明和黑色两种，黑色管壳几乎只透过红外光，与红外发光管配套使用。

　　光敏电阻的电特性是电阻而不是恒流，受到光照后电阻值大幅度减小，输出电流也较大，数量级类似光电三极管。工作频率一般较低，但也有高的。在使用上最重要的区别在于光敏电阻接受光照的是一个平面，没有管壳聚光，方向性差。一般用在不区分光照方向或者要降低成本的电路里。

　　接收管的光谱特性：

　　光电二极管，光电三极管都是半导体PN结光电元件，靠内光电效应接收光线，因此入射光子能量超过材料能带宽度才能被接收，表现在它的光谱-灵敏度特性在长波方向有一个陡的截止。在短波方向如果波长太短，灵敏度也会下降。一般的硅管最适合用在红外到红黄光范围内，但是可以一直用到近紫外。

　　另类的应用：用发光二极管当光电二极管，它的材料能带较宽，只接收短波的可见光。理论上可以用于识别颜色。

　　某些光敏电阻对于可见光中间部分的灵敏度较高。

　　加装滤色片（可以用玻璃纸）可以方便的改变管子的光谱特性以制造各种颜色传感器。

###传感器探头的实际制作

####识别白线：

　　可以用白色管子。如果背景是绿色，红光比较好用，红外也行。但是背景有红绿蓝各种颜色特别是红色时，红光的区分度就不大了。比如Robocon比赛的红色或者蓝色的出发区。这次我们校队就因为没有注意这个问题而吃了大亏。在这种情况下可以用蓝色，红色或紫色（验钞用，含紫外线）的管子。

　　几何形状是发射管和接收管一个直立一个倾斜，指向同一个位置以消除镜面反射光。

　　这些管子可以焊在一小块电路板上,在前端套上热缩套管减小光线发散,这样做成探头,但是这样既不坚固准确又不抗干扰,最麻烦的是多个探头作成阵列使用时性能不一致。较好的做法是在一个铝块或木块上打孔后把管子插在里面，周围围上黑胶布遮光。探头的光斑要小，这样识别白线才准确。相邻的探头距离要合适。

　　探头的布置是出于控制方便的考虑，一般是中间放一排探头跟踪白线，两边各一个数横线。中间的这一排探头要放在驱动轮前面，距离尽量的远，数量尽量的多。因为车身偏离白线的时候是先有角度偏差再累积（积分）为横向偏差，两个相加后构成探头与白线的偏差。

　　探头越靠前，角度偏差占的比例越大，反馈的相位滞后越小，环路越容易稳定，振荡小。相反的，探头靠后了就会振荡的比较大甚至发散。探头在最前面，驱动轮在最后面，用2个探头就能用了。考虑到转弯时可能产生比较大的横向偏差，最好放3个。

　　我们今年在比赛失败的直接原因就是清障的小机器人跟踪白线的探头只有两个，而且有两个万向轮，驱动轮打滑严重。在自己搭的场地上从来没出问题，但是一到北京就出问题不可收拾，结果障碍物无法清除，把冲顶机器人挡住了。

　　探头靠后了就要多放几个.如果放在两个驱动轮之间就要放一长排,用PID算法.

　　为了避免镜面反射，如果使用平行的发光管和接收管，在指向待测点的前提下，应不要垂直于待测表面，应该有个倾角。另外，探头的安装离待测点的距离要根据电路灵敏度和信噪比来定，非调制的传感器探头要注意遮光。

###识别各种颜色：

　　如果要识别各种颜色，可以用带不同滤色片的接收管，或者几个不同颜色的发射管轮流点亮（包括全部熄灭的状态）用一个接收管接收，再作A/D转换后由单片机处理。几个管子必须是识别同一个地方的颜色，并且相对距离不能变动。否则会把黑白认成彩色。

###接近开关：

　　识别有物体靠近，可以用红外对管+调制，或者直接购买成品。

<br/>
<br/>

